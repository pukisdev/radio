app.controller('liburController', function($scope, $http, API_URL) {
	$scope.libraryTemp = {};
  $scope.totalItemsTemp = {};
  $scope.totalItems = 0;
  $scope.subUrl = 'pms/libur';
  $modalName ='idModalLibur';
  // $idScope = 'id_tanggal';
    //retrieve employees listing from API
    getResultsPage(1);

    //show modal form
    $scope.toggle = function(modalstate, id){
      $scope.modalstate = modalstate; 

      switch(modalstate){
        case 'add' :
          $scope.form_title = 'Tambah Data';
          $scope.libur = null;
        break;
        case 'edit' :
          $scope.form_title = 'Edit Data';
          $scope.idState = id;
          $http.get(API_URL + $scope.subUrl+"/" + id)
            .success(function(response){
              // console.log(response);
              $scope.libur = response;
              // $scope.libur = $filter('date')(response, "dd/MM/yyyy");
              // $scope.libur = {
              //   id_tanggal : new Date('2016-03-14')
              // };
            });
        break;
        default:
        break;
      }

      $('#'+$modalName).modal('show');
    }

    $scope.save = function(modalstate, id){
      var _url = API_URL + $scope.subUrl;
      var _method = (modalstate === 'edit') ? 'PUT' : 'POST';

      if(modalstate ==='edit') _url += '/'+id;

      // console.log(id);
      $http({
        'method'  : _method,
        'url'     : _url,
        'data'    : $.param($scope.libur),
        'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
      }).success(function(response){
        // console.log(response);
        if(modalstate === 'edit') {
          $scope.tanggals = apiModifyTable($scope.tanggals, response.id_tanggal, response);
        }
        else {
          // console.log(response);
          $scope.tanggals.push(response);
        }
          
        $('#'+$modalName).modal('hide');
        $.gritter.add({
              title: 'Application',
              text: 'Data Berhasil Disimpan',
              fade_out_speed: 5000
          });
        // location.reload();
      }).error(function(error){
        console.log(error);
      });

    }

    $scope.confirmDelete = function(_data, _index){
      var isConfirmDelete = confirm('Anda yakin mau menghapus data ini?');
      if(isConfirmDelete){
        $http({
          'method'  : 'DELETE',
          'url'   : API_URL+$scope.subUrl+'/'+_data.id_tanggal 
        }).success(function(response){
        $scope.tanggals.splice(_index,1);
          $.gritter.add({
                title: 'Application',
                text: 'Data Berhasil Dihapus',
                fade_out_speed: 5000
            });
        }).error(function(response){
          console.log(response);
          $.gritter.add({
                title: 'Application',
                text: 'Data Gagal Dihapus',
                fade_out_speed: 5000
            });
        });
      }
    }
  
    $scope.searchDB = function(){
        if($scope.searchText.length >= 1){
          // console.log($scope.libraryTemp);
          if($.isEmptyObject($scope.libraryTemp)){
                $scope.libraryTemp = $scope.tanggals;
                $scope.totalItemsTemp = $scope.totalItems;
                $scope.tanggals = {};
          }
          getResultsPage(1);
        }else{
          // console.log('masuk');
            if(!$.isEmptyObject($scope.libraryTemp)){
                $scope.tanggals = $scope.libraryTemp ;
                $scope.totalItems = $scope.totalItemsTemp;
                $scope.libraryTemp = {};
            }
        }
    }

    $scope.pageChanged = function(newPage) {
      getResultsPage(newPage);
    };
/*

*/
  function getResultsPage(pageNumber) {
      if(! $.isEmptyObject($scope.libraryTemp)){
        $http({
          'method'  : 'GET',
          'url'   : API_URL+$scope.subUrl+'?search='+$scope.searchText+'&page='+pageNumber 
        }).success(function(response){
          // console.log(response);
          $scope.tanggals     = response.data;
          $scope.totalItems   = response.total;
          $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
            console.log(response);
        });
      }else{
        $http({
          'method'  : 'GET',
          'url'   : API_URL+$scope.subUrl+'?page='+pageNumber 
        }).success(function(response){
          // console.log(response);
          $scope.tanggals     = response.data;
          $scope.totalItems   = response.total;
          $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
          console.log(response);
        });
      }
  }
  
  // $scope.dt = new Date();
  
  // $scope.inlineOptions = {
  //   customClass: getDayClass,
  //   minDate: new Date(),
  //   showWeeks: true
  // };

  $scope.dateOptions = {
    dateDisabled: disabled,
    formatYear: 'yy',
    maxDate: new Date(2020, 5, 22),
    minDate: new Date(),
    startingDay: 1
  };

  // Disable weekend selection
  function disabled(data) {
    var date = data.date,
      mode = data.mode;
    return mode === 'day' && (date.getDay() === 0 || date.getDay() === 6);
  }

  $scope.open1 = function() {
    $scope.popup1.opened = true;
  };

  $scope.format = 'yyyy-MM-dd';
  $scope.altInputFormats = ['yyyy/M!/d!'];
  // $scope.formats = ['yyyy/MM/dd', 'shortDate'];
  // $scope.formats = ['dd-MMMM-yyyy', 'yyyy/MM/dd', 'dd.MM.yyyy', 'shortDate'];
  // $scope.format = $scope.formats[0];
  // $scope.altInputFormats = ['M!/d!/yyyy'];

  $scope.popup1 = {
    opened: false
  };

  // console.log($scope.libur);
  // function getDayClass(data) {
  //     var date = data.date,
  //       mode = data.mode;
  //     if (mode === 'day') {
  //       var dayToCheck = new Date(date).setHours(0,0,0,0);

  //       for (var i = 0; i < $scope.events.length; i++) {
  //         var currentDay = new Date($scope.events[i].date).setHours(0,0,0,0);

  //         if (dayToCheck === currentDay) {
  //           return $scope.events[i].status;
  //         }
  //       }
  //     }

  //   return '';
  // }
});

app.directive('modalLibur', function (){
    return{
        restirct    : 'A',
        templateUrl : '/ext/ng-html/modalLibur.html',
    };
});

  // app.filter('myDateFormat', function myDateFormat($filter){
  //   return function(text){
  //     var  tempdate= new Date(text.replace(/-/g,"/"));
  //     return $filter('date')(tempdate, "MMM-dd-yyyy");
  //   }
  // });

function apiModifyTable(originalData,id,response){
    angular.forEach(originalData, function (item,key) {
      // console.log(item.id_tanggal +' \\ '+key+' / '+id);
        if(item.id_tanggal == id){
            originalData[key] = response;
        }
    });
    return originalData;
}