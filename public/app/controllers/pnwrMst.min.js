  
var app = angular
      .module('appRoot', ['ngMessages','angularUtils.directives.dirPagination', 'ngRoute', 'currencyMask', 'ngMask', 'ui.bootstrap','rte-angular'])
      .constant('API_URL', 'http://radio.green/')
      .config(function($routeProvider, $interpolateProvider){ 
      // .config(function($interpolateProvider){ 
          $interpolateProvider.startSymbol('[[').endSymbol(']]');
      })
      .directive('loading', ['$http',function($http){
          return {
            restrict: 'A',
            link : function(scope, element, attrs){
              scope.isLoading = function(){
                return $http.pendingRequests.length > 0;
              };

              scope.$watch(scope.isLoading, function(value){
                if(value){
                  element.show(); 
                } else{
                  element.hide();
                }
              })
            }
          }
        }]);

// app.config(function($routeProvider, $interpolateProvider){ 
//   $interpolateProvider.startSymbol('[[').endSymbol(']]');
// });

// app.controller('dataFormController', function($scope, $http, API_URL) {
app.controller('dataFormController', function($scope, $http, $uibModal, $log, API_URL) {
  $scope.parseInt = parseInt;
  $scope.libraryTemp = {};
	$scope.dataForm = {};
  $scope.totalItemsTemp = {};
  $scope.totalItems = 0;
  $scope.subUrl = 'pms/pnwrMst';
  $modalName ='idModalMst';

    //retrieve employees listing from API
    getResultsPage(1);

    //show modal form
    $scope.toggle = function(modalstate, id){
      $scope.modalstate = modalstate; 

      switch(modalstate){
        case 'add' :
          $scope.form_title = 'Tambah Data';
          $scope.dataForm = null;
        break;
        case 'edit' :
          $scope.form_title = 'Edit Data';
          $scope.idState = id;
          // $http.get(API_URL + $scope.subUrl+"/" + id)
          $http({
            'method'  : "GET",
            'url'     : API_URL + $scope.subUrl+"/edit",
            'params'  : {"_id" : id} ,
            'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
          }).success(function(response){
              // console.log(response);
              $scope.dataForm = response;
              $scope.dataForm['f_produk'] = response.produk['id_produk'];
              $scope.dataForm['nama_produk'] = response.produk['nama'];
              $scope.dataForm['durasi'] = response.produk['durasi'];
              $scope.dataForm['f_customer'] = response.customer['id_customer'];
              $scope.dataForm['nama_customer'] = response.customer['nama_customer'];
            });
        break;
        default:
        break;
      }
      $scope.formTampil = true;
      // $('#'+$modalName).show('slow');
      // $('#'+$modalName).modal('show');
    }

    $scope.save = function(modalstate, id){
      var _url = API_URL + $scope.subUrl;
      var _method = (modalstate === 'edit') ? 'PUT' : 'POST';

      // if(modalstate ==='edit') _url += '/'+id;
      if(modalstate ==='edit') _url += '/1234';

      // console.log(id);
      $http({
        'method'  : _method,
        'url'     : _url,
        'data'    : $.param($scope.dataForm),
        'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
      }).success(function(response){
        console.log(response);
        // if(modalstate === 'edit') {
        //   $scope._data = apiModifyTable($scope._data, response.id_pnwr, response);
        // }
        // else {
        //   $scope._data.push(response);
        // }

        $scope.toggle(modalstate,id)
        
        // $scope.formTampil = false;  
        // $('#'+$modalName).modal('hide');
        $.gritter.add({
              title: 'Application',
              text: 'Data Berhasil Disimpan',
              fade_out_speed: 5000
          });
      }).error(function(error){
        console.log(error);
      });

    }

    $scope.confirmDelete = function(_data, _index){
      var isConfirmDelete = confirm('Anda yakin mau menghapus data ini?');
      if(isConfirmDelete){
        $http({
          'method'  : 'DELETE',
          // 'url'     : API_URL+$scope.subUrl+'/'+_data.id_pnwr,
          'url'     : API_URL+$scope.subUrl+'/delete',
          'params'  : {"_id" : _data.id_pnwr} 
        }).success(function(response){
          $scope._data.splice(_index,1);
          $.gritter.add({
                title: 'Application',
                text: 'Data Berhasil Dihapus',
                fade_out_speed: 5000
            });
        }).error(function(response){
          console.log(response);
          $.gritter.add({
                title: 'Application',
                text: 'Data Gagal Dihapus',
                fade_out_speed: 5000
            });
        });
      }
    }
  
    $scope.searchDB = function(){
        if($scope.searchText.length >= 1){
          // console.log($scope.libraryTemp);
          if($.isEmptyObject($scope.libraryTemp)){
                $scope.libraryTemp = $scope._data;
                $scope.totalItemsTemp = $scope.totalItems;
                $scope._data = {};
          }
          getResultsPage(1);
        }else{
          // console.log('masuk');
            if(!$.isEmptyObject($scope.libraryTemp)){
                $scope._data = $scope.libraryTemp ;
                $scope.totalItems = $scope.totalItemsTemp;
                $scope.libraryTemp = {};
            }
        }
    }

    $scope.pageChanged = function(newPage) {
      getResultsPage(newPage);
    };
/*

*/
  function getResultsPage(pageNumber) {
      if(! $.isEmptyObject($scope.libraryTemp)){
        $http({
          'method'  : 'GET',
          'url'   : API_URL+$scope.subUrl+'?search='+$scope.searchText+'&page='+pageNumber 
        }).success(function(response){
          // console.log(response);
          $scope._data     = response.data;
          $scope.totalItems   = response.total;
          $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
            console.log(response);
        });
      }else{
        $http({
          'method'  : 'GET',
          'url'   : API_URL+$scope.subUrl+'?page='+pageNumber 
        }).success(function(response){
          // console.log(response);
          $scope._data     = response.data;
          $scope.totalItems   = response.total;
          $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
          console.log(response);
        });
      }
  }

  $scope.lovSelected = function(idModal, _element){
    
    if($.isEmptyObject($scope.dataForm)){
      $scope.dataForm = {};
    }

    angular.forEach(_element, function (item,key) {
      // console.log(key + '||' +key.indexOf('id'));
      key = (key.indexOf('id') > -1) ? 'f_'+key.substr(3) : key;
      $scope.dataForm[key] = item;
    });
    
    $('#'+idModal).modal('hide');
  }

  $scope.showModal = function (idModal){
    $('#'+idModal).modal('show');
    // $('#idModulProduk').modal('show')
    // getResultsPageCustomer(1);

    // console.log('test : '+idModal);
  }

  $scope.lovProdukSelected = function(idModal, _element){
    if($.isEmptyObject($scope.dataForm)){
      $scope.dataForm = {};
    }

    // console.log(_element.nama);
    $scope.dataForm['nama_produk'] = _element.nama;
    $scope.dataForm['f_produk'] = _element.id_produk; 
    // $scope.dataForm['f_tarif'] = _element.tarif[0].id_tarif; 
    $scope.dataForm['tarif'] = _element.tarif[0].harga; 
    $scope.dataForm['durasi'] = _element.durasi; 
    // $scope.dataForm['tarif_normal'] = _element.tarif[0].harga; 
    $('#'+idModal).modal('hide');
    $scope.total_normal();
  }

  $scope.nilai_rp_diskon = function(){
    _potongan     = ($scope.dataForm['tarif_diskon'] > 0) ? (_tarifNormal * $scope.dataForm['tarif_diskon'] / 100) : 0;  
    $scope.dataForm['tarif_potongan'] = _potongan ; 
    $scope.total_normal();
  }

  $scope.total_normal = function(){
    _tarifNormal  = $scope.dataForm['frekuensi'] * $scope.dataForm['periode'] * $scope.dataForm['tarif'] ; 
    // _potongan     = ($scope.dataForm['tarif_potongan'] > 0 ) ?  $scope.dataForm['tarif_potongan'] : 0;  
    _potongan     = ($scope.dataForm['tarif_diskon'] > 0) ? (_tarifNormal * $scope.dataForm['tarif_diskon'] / 100) : (($scope.dataForm['tarif_potongan'] > 0 ) ?  $scope.dataForm['tarif_potongan'] : 0);  
    _hpp          = _tarifNormal - _potongan;  
    _tarifPPN     = _hpp * 0.1;  
    _totalNormal  = _hpp + _tarifPPN;  
    _totalTayang  = $scope.dataForm['frekuensi'] * $scope.dataForm['periode'];

    $scope.dataForm['tarif_normal'] = _tarifNormal ; 
    $scope.dataForm['tarif_potongan'] = _potongan ; 
    $scope.dataForm['tarif_hpp'] = _hpp ; 
    $scope.dataForm['tarif_ppn'] = _tarifPPN ; 
    $scope.dataForm['tarif_total'] = _totalNormal ; 
    $scope.dataForm['total_tayang'] = _totalTayang ; 
  }

  $scope.totalDeal = function(){
    _totalDeal  = $scope.dataForm['pnwr_total'];
    _hppDeal    = _totalDeal / 1.1;
    _ppnDeal    = _totalDeal - _hppDeal;
    // console.log('hpp : '+_ppnDeal);

    $scope.dataForm['pnwr_hpp'] = _hppDeal;
    $scope.dataForm['pnwr_ppn'] = _ppnDeal;
  }

  // $scope.items = ['item1', 'item2', 'item3'];

  // $scope.params = {}
  // $scope.params = { periode : function() { return $scope.dataForm['periode'] }, frekuensi : function () { return $scope.dataForm['frekuensi']}};
  $scope.openTayang = function () {
    $scope.params = { _periode : $scope.dataForm['periode'] , _frekuensi : $scope.dataForm['frekuensi'], _f_pnwr : $scope.dataForm['id_pnwr']  };
    // console.log($scope.dataForm['periode']);
    // console.log($scope.dataForm);
    // console.log($scope.params['periode']);
    var modalInstance = $uibModal.open({
      animation: true,
      templateUrl: '/ext/ng-html/PMS/form/pnwrTayang.html',
      controller: //function($scope,  $uibModalInstance, parameter)
                  'ModalInstanceCtrl',
                  // {
                  //   $scope.params = parameter;
                  //   console.log($scope.params);  
                  // },
  //     // size: size,
      size: 'lg',
      resolve: {
        parameter : function(){
          return $scope.params;
          // return $scope.params;
          // return { periode : function() { return $scope.dataForm['periode'] }, frekuensi : function () { return $scope.dataForm['frekuensi'] } };
        }, 
        // parameterOut : function(){
        //   return $scope.dataModal; 
        // } 
        // periode    : function () {
        //   return $scope.dataForm['periode'];
        // },
        // frekuensi  : function () {
        //   return $scope.dataForm['frekuensi'];
        // },
      }
    });
    modalInstance.result.then(function (selectedItem) {
      // $scope.selected = selectedItem;
    }, function () {
      $log.info('Modal dismissed at: ' + new Date());
    });


  }

  $scope.openMateri = function () {
    $scope.params = { _f_pnwr : $scope.dataForm['id_pnwr']  };
    var modalInstance = $uibModal.open({
      animation: true,
      templateUrl: '/ext/ng-html/PMS/form/pnwrMateri.html',
      controller: 'ModalCtrlMateri',
      size: 'lg',
      resolve: {
        parameter : function(){
          return $scope.params;
        }, 
      }
    });
    modalInstance.result.then(function (selectedItem) {
      // $scope.selected = selectedItem;
    }, function () {
      $log.info('Modal dismissed at: ' + new Date());
    });
  }
});

app.directive('formPnwrMst', function (){
    return{
        restirct    : 'A',
        templateUrl : '/ext/ng-html/formPnwrMst.html',
    };
});

app.directive('lovCustomer', function (){
    return{
        restirct    : 'A',
        templateUrl : '/ext/ng-html/PMS/lov/lovCustomer.html',
    };
});

app.directive('lovProduk', function (){
    return{
        restirct    : 'A',
        templateUrl : '/ext/ng-html/PMS/lov/lovProduk.html',
    };
});

// app.directive('lovModal', function() {
//     return {
//         restrict: 'E',
//         templateUrl: '/ext/ng-html/PMS/form/pnwrTayang.html',
//         controller: function ($scope) {
//           $scope.selected = {
//             item: $scope.items[0] 
//           };
//         }
//     };
// });

// // app.controller('lovTayangController', function($scope, $http, API_URL) {
// app.controller('lovTayangController', function($scope, $uibModal, $log){
//   $scope.items = ['item1', 'item2', 'item3'];

//   $scope.open = function (size) {
//     console.log('masuk');
//     var modalInstance = $uibModal.open({
//       // animation: $scope.animationsEnabled,
//       templateUrl: '/ext/ng-html/PMS/form/pnwrTayang.html',
//       controller: 'ModalInstanceCtrl',
//       // size: size,
//       size: 'lg',
//       resolve: {
//         items: function () {
//           return $scope.items;
//         }
//       }
//     });

//     modalInstance.result.then(function (selectedItem) {
//       $scope.selected = selectedItem;
//     }, function () {
//       $log.info('Modal dismissed at: ' + new Date());
//     });
//   };
// });


// app.controller('ModalInstanceCtrl', function ($scope, $uibModalInstance, $rootScope, params, periode, frekuensi) {
app.controller('ModalInstanceCtrl', function ($scope, $http, $uibModalInstance, parameter, API_URL) {
  $scope.dataModal = {}
  $scope.parameter = parameter;
  $scope.subUrl = 'pms/pnwrTayang';


  // $scope.parameterOut = parameterOut;
  // console.log($scope.params);
  // alert('kenape nih?');
  $scope._periode = Array.apply(0, Array($scope.parameter['_periode'])).map(function(val, i) { return i; });
  $scope._frekuensi = Array.apply(0, Array($scope.parameter['_frekuensi'])).map(function(val, i) { return i; });
  $scope.dataModal['f_pnwr'] = $scope.parameter['_f_pnwr'];
  // $scope.dataModal = {
  //   item: $scope.items[0]
  // };
  getTayang();


  $scope.simpan = function (modalstate, id) {
    // console.log(JSON.stringify({$scope.dataModal[0]},{$scope.dataModal[0]}, $scope.dataModal['f_pnwr']));
    // _test = {$scope.dataModal[0], $scope.dataModal[1], $scope.dataModal['f_pnwr']};
    // console.log(new Object($scope.dataModal));
    console.log($.param($scope.dataModal));
    // console.log(_test);

    _url = API_URL + $scope.subUrl;
    _method = (modalstate === 'edit') ? 'PUT' : 'POST';

    // if(modalstate ==='edit') _url += '/'+id;

    // _data = $.param($scope.dataModal);
  
    // if( typeof _data === 'undefined' || _data === null ){
    //     // console.log($.param({$scope.dataModal}));
    //     $scope.dataModal = new Object($scope.dataModal);
    // }


    $http({
      'method'  : _method,
      'url'     : _url,
      'data'    : $.param($scope.dataModal), //( typeof _data === 'undefined' || _data === null ) ?  null : _data,
      'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
    }).success(function(response){
        for(isi in response){
          response[isi]['tayang_tgl'] =  new Date(response[isi]['tayang_tgl']);
          $scope.dataModal[isi]       = response[isi];
        }
        $scope.dataModal['f_pnwr']     = $scope.parameter['f_pnwr'];

      // console.log(response);
      // if(modalstate === 'edit') {
      //   $scope._data = apiModifyTable($scope._data, response.id_pnwr, response);
      // }
      // else {
      //   $scope._data.push(response);
      // }

      // $scope.toggle(modalstate,id)
      
      // $scope.formTampil = false;  
      // $('#'+$modalName).modal('hide');
      $.gritter.add({
            title: 'Application',
            text: 'Data Berhasil Disimpan',
            fade_out_speed: 5000
      });

      // getTayang();
        // $uibModalInstance.close(null);
    }).error(function(error){
      console.log(error);
    });

  }

  $scope.cancel = function () {
    $uibModalInstance.dismiss('cancel');
  };

  function getTayang() {
        $http({
          'method'  : 'GET',
          'url'     : API_URL+$scope.subUrl+'/edit',
          'params'  : {"_id" : $scope.parameter['_f_pnwr']} 
        }).success(function(response){
          // console.log($scope.dataModal);
          // $scope.dataModal = {};
          // if(! $.isEmptyObject(response)){
            for(isi in response){
              response[isi]['tayang_tgl'] =  new Date(response[isi]['tayang_tgl']);
              $scope.dataModal[isi]       = response[isi];
            }

            // $scope.dataModal           = response;
            $scope.dataModal['f_pnwr']    = $scope.parameter['_f_pnwr'];

            // console.log($scope.parameter['_f_pnwr']);
          // }
        }).error(function(response){
          console.log(response);
        });
  }

});

app.controller('ModalCtrlMateri', function ($scope, $http, $sce, $uibModalInstance, parameter, API_URL) {
  $scope.dataModal = {}
  $scope.dataModalParam = {}
  $scope.parameter = parameter;
  $scope.subUrl = 'pms/pnwrMateri';
  // $scope.modalstate = 'new';

  $scope.dataModal['f_pnwr'] = $scope.parameter['_f_pnwr'];

  getMateri();

  $scope.simpan = function () {
    $scope.dataModalParam = angular.copy($scope.dataModal);
    // if($scope.modalstate === 'edit')
    $scope.dataModalParam['materi_tayang'] = $scope.dataModal['materi_tayang'].toString();
     
    // console.log($scope.dataModalParam);
    $http({
      'method'  : 'POST',
      'url'     : API_URL + $scope.subUrl,
      'data'    : $.param($scope.dataModalParam), 
      'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
    }).success(function(response){
        // $scope.dataModal['f_pnwr']     = $scope.parameter['f_pnwr'];
        $.gritter.add({
              title: 'Application',
              text: 'Data Berhasil Disimpan',
              fade_out_speed: 5000
        });
        // $uibModalInstance.close(null);

   }).error(function(error){
      console.log(error);
    });

  }

  $scope.cancel = function () {
    $uibModalInstance.dismiss('cancel');
  };

  function getMateri() {
        $http({
          'method'  : 'GET',
          'url'     : API_URL+$scope.subUrl+'/rianday',
          'params'  : {"_id" : $scope.parameter['_f_pnwr']} 
        }).success(function(response){
            // console.log(response);
            // for(isi in response){
            //   response[isi]['tayang_tgl'] =  new Date(response[isi]['tayang_tgl']);
            //   $scope.dataModal[isi]       = response[isi];
            // }
            // if(!$.isEmptyObject(response)){
              $scope.dataModal['materi_tayang'] =  $sce.trustAsHtml(response.materi_tayang);
              $scope.dataModal['f_pnwr']    = $scope.parameter['_f_pnwr'];
              // $scope.modalstate = 'edit';
            // } else {
              // $scope.dataModal = {}
              // $scope.modalstate = 'new';
            // }

        }).error(function(response){
          console.log(response);
        });
  }

});

function apiModifyTable(originalData,id,response){
    angular.forEach(originalData, function (item,key) {
      // console.log(item.id_pnwr +' \\ '+key+' / '+id);
        if(item.id_pnwr == id){
            originalData[key] = response;
        }
    });
    return originalData;
}