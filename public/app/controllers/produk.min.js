app.controller('produkController', function($scope, $http){//, API_URL) {
	$scope.libraryTemp = {};
  	$scope.totalItemsTemp = {};
  	$scope.totalItems = 0;
    $scope.subUrl = '/pms/produk';
    $scope._token = {};

    $http({
      'method'  : 'GET',
      'url'   : '/token' 
    }).success(function(response){
      // console.log(response);
      $scope._token     = response;

      //retrieve employees listing from API
      getResultsPage(1);

    }).error(function(response){
        console.log(response);
    });



    //show modal form
	  $scope.toggle = function(modalstate, id){
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;

    	$scope.modalstate = modalstate; //untuk memberi nilai ke ng-click="save(modalstate, id_produk)". jadi nanti setiap elemen ng-... otomatis ke set nilainya
    	// console.log(id);

    	switch(modalstate){
    		case 'add' :
    			$scope.form_title = 'Tambah Data';
    			$scope.produk = null;
    		break;
    		case 'edit' :
    			$scope.form_title = 'Edit Data';
    			$scope.id_produk = id;
    			$http.get(_url+"/"+id)
    				.success(function(response){
    					$scope.produk = response;
    				});
    		break;
    		default:
    		break;
    	}

    	$('#myModal').modal('show');
    }

    $scope.save = function(modalstate, id){
    	// var _url = API_URL + 'pms/produk';
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;
    	
      var _method = (modalstate === 'edit') ? 'PUT' : 'POST';

    	// if(modalstate ==='edit') _url += '/'+id;

    	$http({
    		'method' 	: _method,
        'url'     : _url + ((modalstate ==='edit') ? '/'+id : ''),
    		// 'url'		: _url,
    		'data'		: $.param($scope.produk),
    		'headers'	: {'Content-Type': 'application/x-www-form-urlencoded'}
    	}).success(function(response){
    		// console.log('modal : '+response.id_produk);
    		if(modalstate === 'edit') {
    			$scope.produks = apiModifyTable($scope.produks, response.id_produk, response);
    		}
    		else {
    			$scope.produks.push(response);
    		}
    			
    		$('#myModal').modal('hide');
    		$.gritter.add({
	            title: 'Application',
	            text: 'Data Berhasil Disimpan',
	            fade_out_speed: 5000
	        });
    		// location.reload();
    	}).error(function(error){
    		console.log(error);
    	});

    }

    $scope.confirmDelete = function(_produks, _index){
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;

      var isConfirmDelete = confirm('Anda yakin mau menghapus data ini?');
    	if(isConfirmDelete){
    		$http({
    			'method'	: 'DELETE',
          'url'     : _url+'/'+_produks.id_produk 
    			// 'url'		: API_URL+'pms/produk/'+_produks.id_produk 
    		}).success(function(response){
				$scope.produks.splice(_index,1);
	    		$.gritter.add({
		            title: 'Application',
		            text: 'Data Berhasil Dihapus',
		            fade_out_speed: 5000
		        });
    		}).error(function(response){
	    		console.log(response);
	    		$.gritter.add({
		            title: 'Application',
		            text: 'Data Gagal Dihapus',
		            fade_out_speed: 5000
		        });
    		});
    	}
    }
  
  	$scope.searchDB = function(){
      	if($scope.searchText.length >= 1){
      		// console.log($scope.libraryTemp);
      		if($.isEmptyObject($scope.libraryTemp)){
              	$scope.libraryTemp = $scope.produks;
              	$scope.totalItemsTemp = $scope.totalItems;
              	$scope.produks = {};
       		}
          getResultsPage(1);
      	}else{
          // console.log('masuk');
          	if(!$.isEmptyObject($scope.libraryTemp)){
              	$scope.produks = $scope.libraryTemp ;
              	$scope.totalItems = $scope.totalItemsTemp;
              	$scope.libraryTemp = {};
          	}
      	}
  	}

  	$scope.pageChanged = function(newPage) {
    	getResultsPage(newPage);
  	};

	function getResultsPage(pageNumber) {
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;

		// console.log($scope.libraryTemp);
	    if(! $.isEmptyObject($scope.libraryTemp)){
    			$http({
    				'method'	: 'GET',
    				// 'url'		: API_URL+'pms/produk?search='+$scope.searchText+'&page='+pageNumber 
            'url'   : _url+'?search='+$scope.searchText+'&page='+pageNumber 
    			}).success(function(response){
    				// console.log(response);
    				  $scope.produks 		= response.data;
              $scope.totalItems 	= response.total;
              $scope.table = { TotalItems : response.total, CurrentItems : response.to };
              // $scope.tableTotalItems = response.total;
              // $scope.tableCurrentItems = response.to;

          }).error(function(response){
              console.log(response);
          });
      }else{
          $http({
            'method'  : 'GET',
            // 'url'   : API_URL+'pms/produk?page='+pageNumber 
            'url'   : _url+'?page='+pageNumber 
          }).success(function(response){
              $scope.produks    = response.data;
              $scope.totalItems   = response.total;
              $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        	}).error(function(response){
    	    		console.log(response);
          });
	    }
	}
  
  function apiModifyTable(originalData,id,response){
      angular.forEach(originalData, function (item,key) {
        // console.log(item.id_produk +'/'+id);
          if(item.id_produk == id){
              originalData[key] = response;
          }
      });
      return originalData;
  }

//seharusnya dijadikan file js sendiri.. karena baru belajar boleh lah.. 
	$scope.tarif = function(_produk, _id){
    var _url = $scope._token['url'];
    if($.isEmptyObject($scope._token)) return false;
	
  	$scope.modelTarif = {};
		// console.log(_id);
		$http.get(_url + "/pms/tarif/" + _id+'?by=produk')
			.success(function(response){
				// console.log('panjang : '+response.f_produk);
				if(!$.isEmptyObject(response)){
					$scope.modelTarif = response;
				}else {
					$scope.modelTarif 			= {f_produk : _id};
					$scope.modelTarif.produk 	= {nama : _produk};
				}
			});
		$('#idModalTarif').modal('show');	
	}

	$scope.saveTarif = function(){
      var _url = $scope._token['url']+'/pms/tarif';
      if($.isEmptyObject($scope._token)) return false;

		$http({	
    		'method' 	: 'POST',
    		'url'		: _url,
    		'data'		: $.param($scope.modelTarif),
    		'headers'	: {'Content-Type': 'application/x-www-form-urlencoded'}
    	}).success(function(response){
    		console.log(response);
    		$('#idModalTarif').modal('hide');
    		$.gritter.add({
	            title: 'Application',
	            text: 'Data Berhasil Disimpan',
	            fade_out_speed: 5000
	        });
    	}).error(function(error){
    		console.log(error);
    		$.gritter.add({
	            title: 'Application',
	            text: 'Data Gagal Disimpan',
	            fade_out_speed: 5000
	        });
    	});		
	}
});

app.directive('modalTarif', function (){
    return{
        restirct    : 'A',
        templateUrl : '/assets/ng/views/pms/forms/modalTarif.html',
    };
});

app.directive('modalProduk', function (){
    return{
        restirct    : 'A',
        templateUrl : '/assets/ng/views/pms/forms/modalProduk.html',
    };
});
