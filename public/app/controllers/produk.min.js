app.controller('produkController', function($scope, $http, API_URL) {
	$scope.libraryTemp = {};
  	$scope.totalItemsTemp = {};
  	$scope.totalItems = 0;

    //retrieve employees listing from API
    getResultsPage(1);

    //show modal form
	  $scope.toggle = function(modalstate, id){
    	$scope.modalstate = modalstate; //untuk memberi nilai ke ng-click="save(modalstate, id_produk)". jadi nanti setiap elemen ng-... otomatis ke set nilainya
    	// console.log(id);

    	switch(modalstate){
    		case 'add' :
    			$scope.form_title = 'Tambah Data';
    			$scope.produk = null;
    		break;
    		case 'edit' :
    			$scope.form_title = 'Edit Data';
    			$scope.id_produk = id;
    			$http.get(API_URL + "pms/produk/" + id)
    				.success(function(response){
    					$scope.produk = response;
    				});
    		break;
    		default:
    		break;
    	}

    	$('#myModal').modal('show');
    }

    $scope.save = function(modalstate, id){
    	var _url = API_URL + 'pms/produk';
    	var _method = (modalstate === 'edit') ? 'PUT' : 'POST';

    	if(modalstate ==='edit') _url += '/'+id;

    	$http({
    		'method' 	: _method,
    		'url'		: _url,
    		'data'		: $.param($scope.produk),
    		'headers'	: {'Content-Type': 'application/x-www-form-urlencoded'}
    	}).success(function(response){
    		// console.log('modal : '+response.id_produk);
    		if(modalstate === 'edit') {
    			$scope.produks = apiModifyTable($scope.produks, response.id_produk, response);
    		}
    		else {
    			$scope.produks.push(response);
    		}
    			
    		$('#myModal').modal('hide');
    		$.gritter.add({
	            title: 'Application',
	            text: 'Data Berhasil Disimpan',
	            fade_out_speed: 5000
	        });
    		// location.reload();
    	}).error(function(error){
    		console.log(error);
    	});

    }

    $scope.confirmDelete = function(_produks, _index){
    	var isConfirmDelete = confirm('Anda yakin mau menghapus data ini?');
    	if(isConfirmDelete){
    		$http({
    			'method'	: 'DELETE',
    			'url'		: API_URL+'pms/produk/'+_produks.id_produk 
    		}).success(function(response){
				$scope.produks.splice(_index,1);
	    		$.gritter.add({
		            title: 'Application',
		            text: 'Data Berhasil Dihapus',
		            fade_out_speed: 5000
		        });
    		}).error(function(response){
	    		console.log(response);
	    		$.gritter.add({
		            title: 'Application',
		            text: 'Data Gagal Dihapus',
		            fade_out_speed: 5000
		        });
    		});
    	}
    }
  
  	$scope.searchDB = function(){
      	if($scope.searchText.length >= 1){
      		// console.log($scope.libraryTemp);
      		if($.isEmptyObject($scope.libraryTemp)){
              	$scope.libraryTemp = $scope.produks;
              	$scope.totalItemsTemp = $scope.totalItems;
              	$scope.produks = {};
       		}
          getResultsPage(1);
      	}else{
          // console.log('masuk');
          	if(!$.isEmptyObject($scope.libraryTemp)){
              	$scope.produks = $scope.libraryTemp ;
              	$scope.totalItems = $scope.totalItemsTemp;
              	$scope.libraryTemp = {};
          	}
      	}
  	}

  	$scope.pageChanged = function(newPage) {
    	getResultsPage(newPage);
  	};

	function getResultsPage(pageNumber) {
		// console.log($scope.libraryTemp);
	    if(! $.isEmptyObject($scope.libraryTemp)){
    			$http({
    				'method'	: 'GET',
    				'url'		: API_URL+'pms/produk?search='+$scope.searchText+'&page='+pageNumber 
    			}).success(function(response){
    				// console.log(response);
    				  $scope.produks 		= response.data;
              $scope.totalItems 	= response.total;
              $scope.table = { TotalItems : response.total, CurrentItems : response.to };
              // $scope.tableTotalItems = response.total;
              // $scope.tableCurrentItems = response.to;

          }).error(function(response){
              console.log(response);
          });
      }else{
          $http({
            'method'  : 'GET',
            'url'   : API_URL+'pms/produk?page='+pageNumber 
          }).success(function(response){
              $scope.produks    = response.data;
              $scope.totalItems   = response.total;
              $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        	}).error(function(response){
    	    		console.log(response);
          });
	    }
	}

//seharusnya dijadikan file js sendiri.. karena baru belajar boleh lah.. 
	$scope.tarif = function(_produk, _id){
		$scope.modelTarif = {};
		// console.log(_id);
		$http.get(API_URL + "pms/tarif/" + _id+'?by=produk')
			.success(function(response){
				// console.log('panjang : '+response.f_produk);
				if(!$.isEmptyObject(response)){
					$scope.modelTarif = response;
				}else {
					$scope.modelTarif 			= {f_produk : _id};
					$scope.modelTarif.produk 	= {nama : _produk};
				}
			});
		$('#idModalTarif').modal('show');	
	}

	$scope.saveTarif = function(){
		$http({	
    		'method' 	: 'POST',
    		'url'		: API_URL + 'pms/tarif',
    		'data'		: $.param($scope.modelTarif),
    		'headers'	: {'Content-Type': 'application/x-www-form-urlencoded'}
    	}).success(function(response){
    		console.log(response);
    		$('#idModalTarif').modal('hide');
    		$.gritter.add({
	            title: 'Application',
	            text: 'Data Berhasil Disimpan',
	            fade_out_speed: 5000
	        });
    	}).error(function(error){
    		console.log(error);
    		$.gritter.add({
	            title: 'Application',
	            text: 'Data Gagal Disimpan',
	            fade_out_speed: 5000
	        });
    	});		
	}
});

app.directive('modalTarif', function (){
    return{
        restirct    : 'A',
        templateUrl : '/ext/ng-html/modalTarif.html',
    };
});

app.directive('modalProduk', function (){
    return{
        restirct    : 'A',
        templateUrl : '/ext/ng-html/modalProduk.html',
    };
});
