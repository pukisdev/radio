
var app = angular
      .module('appRoot', ['ngMessages','angularUtils.directives.dirPagination', 'ngRoute', 'currencyMask', 'ngMask', 'ui.bootstrap','rte-angular'])
      .constant('API_URL', 'http://radio.green/')
      .config(function($routeProvider, $interpolateProvider){ 
      // .config(function($interpolateProvider){ 
          $interpolateProvider.startSymbol('[[').endSymbol(']]');
      })
      .directive('loading', ['$http',function($http){
          return {
            restrict: 'A',
            link : function(scope, element, attrs){
              scope.isLoading = function(){
                return $http.pendingRequests.length > 0;
              };

              scope.$watch(scope.isLoading, function(value){
                if(value){
                  element.show(); 
                } else{
                  element.hide();
                }
              })
            }
          }
        }]);


app.controller('dataFormController', function($scope, $http, $sce, $uibModal, $log, API_URL) {
  $scope.parseInt = parseInt;
  $scope.libraryTemp = {};
  $scope.dataForm = {};
  $scope.totalItemsTemp = {};
  $scope.totalItems = 0;
  $scope.subUrl = 'pms/fpMst';
  $modalName ='idModalMst';

    //retrieve employees listing from API
    getResultsPage(1);

    //show modal form
    $scope.toggle = function(modalstate, id){
      $scope.modalstate = modalstate; 

      switch(modalstate){
        case 'add' :
          $scope.form_title = 'Tambah Data';
          $scope.dataForm = {};
          $scope.dataForm['fp_det'] = [1];
          $scope.formTampil = true;
        break;
        case 'edit' :
          $scope.form_title = 'Edit Data';
          $scope.idState = id;
          // $http.get(API_URL + $scope.subUrl+"/" + id)
          // console.log($scope.idState);
          $http({
            'method'  : "GET",
            'url'     : API_URL + $scope.subUrl+"/edit",
            'params'  : {"_id" : id} ,
            'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
          }).success(function(response){
              // console.log(response);

              // var abc = [];
              $scope.dataForm['id_fp']            = response.id_fp;
              $scope.dataForm['f_customer']       = response['f_customer'];
              $scope.dataForm['nama_customer']    = response.customer['nama_customer'];
              $scope.dataForm['tgl_fp']           = new Date(response['tgl_fp']);
              $scope.dataForm['tgl_jatuh_tempo']  = new Date(response['tgl_jatuh_tempo']);
              $scope.dataForm['jenis_faktur']     = response['jenis_faktur'];
              $scope.dataForm['ttd']              = response['ttd'];
              $scope.dataForm['keterangan']       = response['keterangan'];
              $scope.dataForm['deskripsi_fp']     = $sce.trustAsHtml(response['deskripsi_fp']);
              // $scope._data = response.fp_det;
  
              for(isi in response.fp_det){
                response.fp_det[isi]['judul_iklan'] =  response.fp_det[isi]['pnwr']['judul_iklan'];
                // $scope.dataForm[isi]      = response.fp_det[isi];
                // console.log(response.fp_det[isi]);
                // $scope.dataForm.fp_det = { [isi] : response.fp_det[isi] };
                // abc.push(response.fp_det[isi]);
              }
              // console.log($.isEmptyObject(response.fp_det));
              $scope.dataForm.fp_det = !$.isEmptyObject(response.fp_det) ? response.fp_det : [1];


              // console.log($scope.dataForm);

            });
          $scope.formTampil = true;
        break;
        case 'cancel':
            // console.log('masuk nih');
          getResultsPage(1);
        break; 
        default:
        break;
      }
    }

    $scope.save = function(modalstate, id){
      var dataFormParam = {}; 
      $scope.dataFormParam = angular.copy($scope.dataForm);
      
      var _url = API_URL + $scope.subUrl + (angular.isUndefined($scope.dataFormParam['id_fp']) ? '' : '/'+id);
      var _method = (angular.isUndefined($scope.dataFormParam['id_fp'])) ? 'POST' : 'PUT';

      // console.log(_url);

      $scope.dataFormParam['deskripsi_fp'] = $scope.dataForm['deskripsi_fp'].toString();

      // if(angular.isUndefined($scope.dataFormParam['id_fp']))
      // if(modalstate ==='edit') _url += '/'+id;
      // if(modalstate ==='edit') _url += '/1234';

      console.log(_url);

      $http({
        'method'  : _method,
        'url'     : _url,
        'data'    : $.param($scope.dataFormParam),
        'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
      }).success(function(response){
        // console.log(response);
        // if(modalstate === 'edit') {
        if(angular.isUndefined($scope.dataFormParam['id_fp'])){
          // $scope._data = apiModifyTable($scope._data, response.id_pnwr, response);
          //toggle('edit', )
        }
        else {
          // $scope._data.push(response);
        }
        console.log(response);

        // $scope.toggle(modalstate,id)
        
        // $scope.formTampil = false;  
        // $('#'+$modalName).modal('hide');
        $.gritter.add({
              title: 'Application',
              text: 'Data Berhasil Disimpan',
              fade_out_speed: 5000
          });
      }).error(function(error){
        console.log(error);
      });

    }

    $scope.confirmDelete = function(_data, _index){
      var isConfirmDelete = confirm('Anda yakin mau menghapus data ini?');
      if(isConfirmDelete){
        $http({
          'method'  : 'DELETE',
          // 'url'     : API_URL+$scope.subUrl+'/'+_data.id_pnwr,
          'url'     : API_URL+$scope.subUrl+'/delete',
          'params'  : {"_id" : _data.id_pnwr} 
        }).success(function(response){
          $scope._data.splice(_index,1);
          $.gritter.add({
                title: 'Application',
                text: 'Data Berhasil Dihapus',
                fade_out_speed: 5000
            });
        }).error(function(response){
          console.log(response);
          $.gritter.add({
                title: 'Application',
                text: 'Data Gagal Dihapus',
                fade_out_speed: 5000
            });
        });
      }
    }
  
    $scope.searchDB = function(){
        if($scope.searchText.length >= 1){
          // console.log($scope.libraryTemp);
          if($.isEmptyObject($scope.libraryTemp)){
                $scope.libraryTemp = $scope._data;
                $scope.totalItemsTemp = $scope.totalItems;
                $scope._data = {};
          }
          getResultsPage(1);
        }else{
          // console.log('masuk');
            if(!$.isEmptyObject($scope.libraryTemp)){
                $scope._data = $scope.libraryTemp ;
                $scope.totalItems = $scope.totalItemsTemp;
                $scope.libraryTemp = {};
            }
        }
    }

    $scope.pageChanged = function(newPage) {
      getResultsPage(newPage);
    };

  function getResultsPage(pageNumber) {
      $scope.formTampil = false;      
      if(! $.isEmptyObject($scope.libraryTemp)){
        $http({
          'method'  : 'GET',
          'url'   : API_URL+$scope.subUrl+'?search='+$scope.searchText+'&page='+pageNumber 
        }).success(function(response){
          console.log(response);
          $scope._data     = response.data;
          $scope.totalItems   = response.total;
          $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
            console.log(response);
        });
      }else{
        $http({
          'method'  : 'GET',
          'url'   : API_URL+$scope.subUrl+'?page='+pageNumber 
        }).success(function(response){
          // console.log(response);
          $scope._data     = response.data;
          $scope.totalItems   = response.total;
          $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
          console.log(response);
        });
      }
  }

  $scope.lovSelected = function(idModal, _element){
    
    if($.isEmptyObject($scope.dataForm)){
      $scope.dataForm = {};
    }

    angular.forEach(_element, function (item,key) {
      // console.log(key + '||' +key.indexOf('id'));
      key = (key.indexOf('id') > -1) ? 'f_'+key.substr(3) : key;
      $scope.dataForm[key] = item;
    });
    
    $('#'+idModal).modal('hide');
  }

  $scope.showModal = function (idModal){
    $('#'+idModal).modal('show');
    // console.log('test : '+idModal);
  }

  $scope.rmLovPnwr = function (_data, _index) {
    // console.log(_data);
    // console.log(_data.f_pnwr +' == '+_data.f_fp);
      var isConfirmDelete = confirm('Anda yakin mau menghapus data ini?');
      if(isConfirmDelete){
        $http({
          'method'  : 'DELETE',
          'url'     : API_URL+'pms/fpDet/delete',
          'params'  : { 'f_pnwr' : _data.f_pnwr, 'f_fp' : _data.f_fp } 
        }).success(function(response){
          $scope.dataForm['fp_det'].splice(_index,1);
          // console.log($scope.dataForm);
          
          $scope.save('edit',$scope.dataForm['id_fp']);
          // $.gritter.add({
          //       title: 'Application',
          //       text: 'Data Berhasil Dihapus',
          //       fade_out_speed: 5000
          // });

        }).error(function(response){
          console.log(response);
          $.gritter.add({
                title: 'Application',
                text: 'Data Gagal Dihapus',
                fade_out_speed: 5000
            });
        });
      }
  }

  $scope.lovPnwr = function (_index, _add) {
    not_in = [];
    angular.forEach($scope.dataForm['fp_det'], function (item,key) {
      // console.log(item.f_pnwr);
      not_in.push(item.f_pnwr);
    });

    $scope.params = {_f_customer : $scope.dataForm['f_customer'], _not_in : not_in};


    var modalInstance = $uibModal.open({
      animation: true,
      templateUrl: '/ext/ng-html/PMS/lov/lovPnwr.html',
      controller: 'lovPnwrController',
      size: 'lg',
      resolve: {
        parameter : function(){
          return $scope.params;
        }, 
      }
    });
    modalInstance.result.then(function (_value) {
      // $scope.selected = _value;
      console.log('masup ke-'+_index);
      console.log(_add);
      console.log(angular.isUndefined($scope.dataForm['fp_det'][_index]['f_pnwr']));
      // i = parseInt($('#table-detail-faktur tr').eq(-1).attr('id').substr(3));
      // j = i+1;
      // console.log(i +'/'+j);


      // if(angular.isUndefined($scope.dataForm['fp_det'][_index]['f_pnwr'])){
      if(_add == 'tambah'){ // && _index > 0) {
        // $('#tr-0').clone().appendTo($('#tr-0').parent());
        // $('#tr-'+i).clone().attr('id', 'tr-'+j.toString()).insertAfter('#tr-'+i);

        // $scope.dataForm[i]['f_pnwr']                  = _value.id_pnwr;
        // $scope.dataForm[i]['judul_iklan']             = _value.judul_iklan;
        // $scope.dataForm[i]['total_biaya']             = _value.pnwr_hpp;
        // $scope.dataForm[i]['nilai_biaya_persen']      = _value.nilai_biaya_persen;
        // $scope.dataForm[i]['nilai_biaya']             = _value.pnwr_hpp;
        // $scope.dataForm[i]['nilai_potongan_persen']   = 0;
        // $scope.dataForm[i]['nilai_potongan']          = 0;
        // $scope.dataForm[i]['nilai_hpp']               = _value.pnwr_hpp;
        // $scope.dataForm[i]['nilai_ppn']               = _value.pnwr_ppn;
        // $scope.dataForm[i]['nilai_akhir']             = _value.pnwr_total;
        
        var _data = new Object();
        _data.f_pnwr                = _value.id_pnwr;
        _data.judul_iklan           = _value.judul_iklan;
        _data.total_biaya           = _value.pnwr_hpp - _value.total_nilai_biaya; //_value.pnwr_hpp;
        _data.nilai_biaya_persen    = !angular.isUndefined(_value.nilai_biaya_persen) ? _value.nilai_biaya_persen : null ; //_value.pnwr_hpp;
        _data.nilai_biaya           = _data.total_biaya;
        _data.nilai_potongan_persen = null;
        _data.nilai_potongan        = null;
        _data.nilai_hpp             = _data.total_biaya; //_value.pnwr_hpp;
        _data.nilai_ppn             = _data.total_biaya * 0.1; //_value.pnwr_total;
        _data.nilai_akhir           = _data.total_biaya + _data.nilai_ppn;
        // console.log(_data );
        $scope.dataForm['fp_det'].push(_data);
        // console.log($scope.dataForm);
      } else {
        if(angular.isUndefined($scope.dataForm['fp_det'][_index]['f_pnwr'])){
          $scope.dataForm['fp_det'][0] = {};
        }  
        _hpp = _value.pnwr_hpp - _value.total_nilai_biaya;
        _ppn = _hpp * 0.1;
        $scope.dataForm['fp_det'][_index]['f_pnwr']               = _value.id_pnwr;
        $scope.dataForm['fp_det'][_index]['judul_iklan']          = _value.judul_iklan;
        $scope.dataForm['fp_det'][_index]['total_biaya']          = _hpp;//_value.pnwr_hpp;
        $scope.dataForm['fp_det'][_index]['nilai_biaya_persen']   = null;//_value.nilai_biaya_persen;
        $scope.dataForm['fp_det'][_index]['nilai_biaya']          = _hpp;//_value.pnwr_hpp;
        $scope.dataForm['fp_det'][_index]['nilai_potongan_persen']= null;
        $scope.dataForm['fp_det'][_index]['nilai_potongan']       = null;
        $scope.dataForm['fp_det'][_index]['nilai_hpp']            = _hpp;//_value.pnwr_hpp;
        $scope.dataForm['fp_det'][_index]['nilai_ppn']            = _ppn; //_value.pnwr_ppn;
        $scope.dataForm['fp_det'][_index]['nilai_akhir']          = _hpp + _ppn;//_value.pnwr_total;

        console.log($scope.dataForm);
      }

    }, function () {
      $log.info('Modal dismissed at: ' + new Date());
    });
  }

  $scope.trace = function(){
    console.log($scope.dataForm);
  }

/*

  $scope.lovProdukSelected = function(idModal, _element){
    if($.isEmptyObject($scope.dataForm)){
      $scope.dataForm = {};
    }

    // console.log(_element.nama);
    $scope.dataForm['nama_produk'] = _element.nama;
    $scope.dataForm['f_produk'] = _element.id_produk; 
    // $scope.dataForm['f_tarif'] = _element.tarif[0].id_tarif; 
    $scope.dataForm['tarif'] = _element.tarif[0].harga; 
    $scope.dataForm['durasi'] = _element.durasi; 
    // $scope.dataForm['tarif_normal'] = _element.tarif[0].harga; 
    $('#'+idModal).modal('hide');
    $scope.total_normal();
  }

*/


  $scope.total = function(_index){

    _totalBiaya   = $scope.dataForm['fp_det'][_index]['total_biaya'];
    _hppPersen    = $scope.dataForm['fp_det'][_index]['nilai_biaya_persen'];
    _hppNilai     = (_hppPersen > 0) ? (_totalBiaya * _hppPersen / 100) : $scope.dataForm['fp_det'][_index]['nilai_biaya'] ;

    if(_hppNilai > _totalBiaya) {
      _hppNilai = _totalBiaya;
      // _hppPersen = null;
    }

    // console.log(_hppPersen == '');
    _potonganPersen  = $scope.dataForm['fp_det'][_index]['nilai_potongan_persen'];
    _potonganNilai   = (_potonganPersen > 0) ? (_hppNilai * _potonganPersen / 100) : $scope.dataForm['fp_det'][_index]['nilai_potongan'];

    _hpp  = _hppNilai - _potonganNilai;
    _ppn  = _hpp * 0.1;
    _netto= _hpp + _ppn;

    // console.log(_hppNilai);
    $scope.dataForm['fp_det'][_index]['nilai_biaya_persen']   = _hppPersen;
    $scope.dataForm['fp_det'][_index]['nilai_biaya']          = _hppNilai;
    $scope.dataForm['fp_det'][_index]['nilai_potongan_persen']= _potonganPersen;
    $scope.dataForm['fp_det'][_index]['nilai_potongan']       = _potonganNilai;
    $scope.dataForm['fp_det'][_index]['nilai_hpp']            = _hpp;
    $scope.dataForm['fp_det'][_index]['nilai_ppn']            = _ppn;
    $scope.dataForm['fp_det'][_index]['nilai_akhir']          = _netto;

  }
   
  // $scope.nilai_rp_diskon = function(){
  //   _potongan     = ($scope.dataForm['tarif_diskon'] > 0) ? (_tarifNormal * $scope.dataForm['tarif_diskon'] / 100) : 0;  
  //   $scope.dataForm['tarif_potongan'] = _potongan ; 
  //   $scope.total_normal();
  // }

  // $scope.total = function(){

  //   _tarifNormal  = $scope.dataForm['frekuensi'] * $scope.dataForm['periode'] * $scope.dataForm['tarif'] ; 
  //   // _potongan     = ($scope.dataForm['tarif_potongan'] > 0 ) ?  $scope.dataForm['tarif_potongan'] : 0;  
  //   _potongan     = ($scope.dataForm['tarif_diskon'] > 0) ? (_tarifNormal * $scope.dataForm['tarif_diskon'] / 100) : (($scope.dataForm['tarif_potongan'] > 0 ) ?  $scope.dataForm['tarif_potongan'] : 0);  
  //   _hpp          = _tarifNormal - _potongan;  
  //   _tarifPPN     = _hpp * 0.1;  
  //   _totalNormal  = _hpp + _tarifPPN;  
  //   _totalTayang  = $scope.dataForm['frekuensi'] * $scope.dataForm['periode'];

  //   $scope.dataForm['tarif_normal'] = _tarifNormal ; 
  //   $scope.dataForm['tarif_potongan'] = _potongan ; 
  //   $scope.dataForm['tarif_hpp'] = _hpp ; 
  //   $scope.dataForm['tarif_ppn'] = _tarifPPN ; 
  //   $scope.dataForm['tarif_total'] = _totalNormal ; 
  //   $scope.dataForm['total_tayang'] = _totalTayang ; 
  // }

  // $scope.totalDeal = function(){
  //   _totalDeal  = $scope.dataForm['pnwr_total'];
  //   _hppDeal    = _totalDeal / 1.1;
  //   _ppnDeal    = _totalDeal - _hppDeal;
  //   // console.log('hpp : '+_ppnDeal);

  //   $scope.dataForm['pnwr_hpp'] = _hppDeal;
  //   $scope.dataForm['pnwr_ppn'] = _ppnDeal;
  // }

}); //the end of dataFormController

app.directive('formFpMst', function (){
    return{
        restirct    : 'A',
        templateUrl : '/ext/ng-html/formFPMst.html',
    };
});

app.directive('lovCustomer', function (){
    return{
        restirct    : 'A',
        templateUrl : '/ext/ng-html/PMS/lov/lovCustomer.html',
    };
});


function apiModifyTable(originalData,id,response){
    angular.forEach(originalData, function (item,key) {
      // console.log(item.id_pnwr +' \\ '+key+' / '+id);
        if(item.id_pnwr == id){
            originalData[key] = response;
        }
    });
    return originalData;
}