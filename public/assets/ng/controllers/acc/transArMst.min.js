var app = angular
          .module('appRoot', ['ngMessages','ngSanitize', 'angularUtils.directives.dirPagination','ngRoute', 'currencyMask', 'ui.bootstrap', 'rte-angular'])
          .config(function($interpolateProvider){
              $interpolateProvider.startSymbol('[[');
              $interpolateProvider.endSymbol(']]');
          })
        .directive('loading', ['$http',function($http){
          return {
            restrict: 'A',
            link : function(scope, element, attrs){
              scope.isLoading = function(){
                return $http.pendingRequests.length > 0;
              };

              scope.$watch(scope.isLoading, function(value){
                if(value){
                  element.show(); 
                } else{
                  element.hide();
                }
              })
            }
          }
        }]);


app.controller('dataFormController', function($scope, $http, $sce, $uibModal, $log) {
  $scope.modalstate = {};
  $scope.parseInt = parseInt;
  $scope.libraryTemp = {};
  $scope.dataForm = {};
  $scope.totalItemsTemp = {};
  $scope.totalItems = 0;
  $scope.subUrl = '/acc/transAr';
  $modalName ='idModalMst';
  $scope._token = {};
  $scope._pageNumber = 1;

    $http({
      'method'  : 'GET',
      'url'   : '/token' 
    }).success(function(response){
      // console.log(response);
      $scope._token     = response;

      //retrieve employees listing from API
      getResultsPage($scope._pageNumber);

    }).error(function(response){
        console.log(response);
    });


    $scope.save = function(modalstate, id){
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;
      $http({
        'method'  : ($scope.dataForm['h_kode_trans']) ? 'PUT' : 'POST',
        'url'     : _url + (($scope.dataForm['h_kode_trans']) ? '/'+$scope.dataForm['h_kode_trans'] : ''),
        'data'    : $.param($scope.dataForm),
        'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
      }).success(function(response){
        
        showData(response);

       }).error(function(error){
        console.log(error);
      });
    }
  
  $scope.searchDB = function(){
    if($.isEmptyObject($scope._token)) return false;
      if($scope.searchText.length >= 1){
        // console.log($scope.libraryTemp);
        if($.isEmptyObject($scope.libraryTemp)){
              $scope.libraryTemp = $scope._data;
              $scope.totalItemsTemp = $scope.totalItems;
              $scope._data = {};
        }
        getResultsPage(1);
      }else{
        // console.log('masuk');
          if(!$.isEmptyObject($scope.libraryTemp)){
              $scope._data = $scope.libraryTemp ;
              $scope.totalItems = $scope.totalItemsTemp;
              $scope.libraryTemp = {};
          }
      }
  }

  $scope.pageChanged = function(newPage) {
    getResultsPage(newPage);
  };

  $scope.formData = function (_value) {
    /*if($.isEmptyObject($scope.dataForm)){
       $scope.dataForm = {};
    }*/

    var _url = $scope._token['url']+ $scope.subUrl;

    $scope.params = { };//_f_customer : (_customer) ? _customer : $scope.dataForm['f_customer']  };
    var modalInstance = $uibModal.open({
      animation   : true,
      templateUrl : '/assets/ng/views/acc/form/formTransArMst.html', 
      // controller  : 'dataFormController',
      controller  : function($scope, modal_url, value) {
          
          if(!$.isEmptyObject(value)){
            $http.get(modal_url+"/"+value)
              .success(function(response){
                 $scope.dataForm                    = {};
                 $scope.dataForm['h_kode_trans']    = response['kode_trans'];           
                 $scope.dataForm['kode_trans']      = response['kode_trans'];           
                 $scope.dataForm['nama_trans']      = response['nama_trans'];           
              }
            );
          }

          $scope.cancel = function () {
            modalInstance.dismiss('cancel');
          };

          $scope.simpan = function(_element){

            console.log($scope.dataForm);            

            $http({
              'method'  : ($scope.dataForm['h_kode_trans']) ? 'PUT' : 'POST',
              'url'     : _url + (($scope.dataForm['h_kode_trans']) ? '/'+$scope.dataForm['h_kode_trans'] : ''),
              'data'    : $.param($scope.dataForm),
              'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
            }).success(function(response){
                new PNotify({
                    title : 'Berhasil',
                    text  : 'Input Data Berhasil',
                    type  : 'success'
                });

             }).error(function(error){
                new PNotify({
                    title : 'Gagal',
                    text  : 'Input Data Gagal',
                    type  : 'error'
                });
                console.log(error);
            });

            getResultsPage(1);
            modalInstance.close(_element);
          };
      },
      size        : 'md',
      resolve     : {
                      parameter : function(){
                        return $scope.params;
                      },
                      modal_url : function(){
                        return _url;
                      },
                      value : function(){
                        return _value;
                      }
                    }
    });
  }  


  function getResultsPage(pageNumber) {
      $scope.formTampil = true;      
      var _url = $scope._token['url']+ $scope.subUrl;
      // console.log(_url);
      if($.isEmptyObject($scope._token)) return false;
      
      $scope._pageNumber = pageNumber;
      
      if(! $.isEmptyObject($scope.libraryTemp)){
        $http({
          'method'  : 'GET',
          'url'   : _url+'?search='+$scope.searchText+'&page='+pageNumber 
        }).success(function(response){
          $scope._data        = response.data;
          $scope.totalItems   = response.total;
          $scope.table        = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
            console.log(response);
        });
      }else{
        $http({
          'method'  : 'GET',
          'url'   : _url+'?page='+pageNumber 
        }).success(function(response){
          $scope._data     = response.data;
          $scope.totalItems   = response.total;
          $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
          console.log(response);
        });
      }
  }

  function showData(_dataTampil){
    $scope.dataForm               = [];
    $scope.dataForm               = _dataTampil;
    $scope.dataForm['tgl_terima'] = new Date(_dataTampil['tgl_terima']);
    $scope.dataForm['keterangan'] = $sce.trustAsHtml(_dataTampil['keterangan']);
    
    for(det in _dataTampil.fa_penerimaan_det){
      _dataTampil.fa_penerimaan_det[det]['nama_bank']       =  _dataTampil.fa_penerimaan_det[det]['fa_bank_mst']['nama_bank'];
      _dataTampil.fa_penerimaan_det[det]['jatuh_tempo']     =  new Date(_dataTampil.fa_penerimaan_det[det]['jatuh_tempo']);
    }

    for(det in _dataTampil.fa_penerimaan_jurnal_det){
      _dataTampil.fa_penerimaan_jurnal_det[det]['nama_coa'] =  (_dataTampil.fa_penerimaan_jurnal_det[det]['coa']) ? _dataTampil.fa_penerimaan_jurnal_det[det]['coa']['coa_name'] : null;
    }

    $scope.dataForm['det']        = _dataTampil.fa_penerimaan_det;
    $scope.dataForm['jurnal_det'] = _dataTampil.fa_penerimaan_jurnal_det;
    $scope.dataForm['ar_det']     = _dataTampil.fa_penerimaan_ar_det;
    $scope.dataForm['ap_det']     = _dataTampil.fa_penerimaan_ap_det;
    delete $scope.dataForm['fa_penerimaan_det'];
    delete $scope.dataForm['fa_penerimaan_jurnal_det'];
    delete $scope.dataForm['fa_penerimaan_ar_det'];
    delete $scope.dataForm['fa_penerimaan_ap_det'];
  }

});

/*app.directive('formTransAr', function (){
    return{
        restirct    : 'A',
        templateUrl : '/assets/ng/views/acc/form/formTransArMst.html',
    };
});*/