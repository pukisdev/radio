var app = angular
          .module('appRoot', ['ngMessages','ngSanitize', 'angularUtils.directives.dirPagination','ngRoute', 'currencyMask', 'ui.bootstrap', 'rte-angular'])
          .config(function($interpolateProvider){
              $interpolateProvider.startSymbol('[[');
              $interpolateProvider.endSymbol(']]');
          })
        .directive('loading', ['$http',function($http){
          return {
            restrict: 'A',
            link : function(scope, element, attrs){
              scope.isLoading = function(){
                return $http.pendingRequests.length > 0;
              };

              scope.$watch(scope.isLoading, function(value){
                if(value){
                  element.show(); 
                } else{
                  element.hide();
                }
              })
            }
          }
        }]);


app.controller('dataFormController', function($scope, $http, $sce, $uibModal, $log) {
  $scope.modalstate = {};
  $scope.parseInt = parseInt;
  $scope.libraryTemp = {};
  $scope.dataForm = {};
  $scope.totalItemsTemp = {};
  $scope.totalItems = 0;
  $scope.subUrl = '/acc/tipe_jurnal';
  $modalName ='idModalMst';
  $scope._token = {};
  $scope._pageNumber = 1;

    $http({
      'method'  : 'GET',
      'url'   : '/token' 
    }).success(function(response){
      //console.log(response);
      $scope._token     = response;
      
      //retrieve employees listing from API
      getResultsPage($scope._pageNumber);

    }).error(function(response){
        //console.log(response);
    });

    //show modal form
  
  $scope.formData = function (_value) {

    var _url = $scope._token['url']+ $scope.subUrl;

    $scope.params = { };//_f_customer : (_customer) ? _customer : $scope.dataForm['f_customer']  };
    var modalInstance = $uibModal.open({
      animation   : true,
      templateUrl : '/assets/ng/views/acc/form/formTipeJurnalMst.html', 
      // controller  : 'dataFormController',
      controller  : function($scope, modal_url, value) {
          
          if(!$.isEmptyObject(value)){
            $http.get(modal_url+"/"+value)
              .success(function(response){
                 $scope.dataForm                    = {};
                 $scope.dataForm['journal_code']    = response['journal_code'];           
                 $scope.dataForm['journal_desc']    = response['journal_desc'];           
              }
            );
          }

          $scope.cancel = function () {
            modalInstance.dismiss('cancel');
          };

          $scope.simpan = function(_element){

            console.log($scope.dataForm);            

            $http({
              'method'  : ($scope.dataForm['journal_code']) ? 'PUT' : 'POST',
              'url'     : _url + (($scope.dataForm['journal_code']) ? '/'+$scope.dataForm['journal_code'] : ''),
              'data'    : $.param($scope.dataForm),
              'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
            }).success(function(response){
                new PNotify({
                    title : 'Berhasil',
                    text  : 'Input Data Berhasil',
                    type  : 'success'
                });

             }).error(function(error){
                new PNotify({
                    title : 'Gagal',
                    text  : 'Input Data Gagal',
                    type  : 'error'
                });
                console.log(error);
            });

            getResultsPage(1);
            modalInstance.close(_element);
          };
      },
      size        : 'md',
      resolve     : {
                      parameter : function(){
                        return $scope.params;
                      },
                      modal_url : function(){
                        return _url;
                      },
                      value : function(){
                        return _value;
                      }
                    }
    });
  }  


  $scope.pageChanged = function(newPage) {
    getResultsPage(newPage);
  };

  $scope.lovSelected = function(idModal, _element){
    
    if($.isEmptyObject($scope.dataForm)){
      $scope.dataForm = {};
    }

    angular.forEach(_element, function (item,key) {
      // console.log(key + '||' +key.indexOf('id'));
      key = (key.indexOf('id') > -1) ? 'f_'+key.substr(3) : key;
      $scope.dataForm[key] = item;
    });
    
    $('#'+idModal).modal('hide');
  }

  $scope.showModal = function (idModal){
    $('#'+idModal).modal('show');
  }

  $scope.selectFile = function(_name){
    // console.log($scope.dataForm[_name].name);
    $scope.dataForm[_name.slice(1)] =  $scope.dataForm[_name].name;
  }

  $scope.getFiles = function(_name){
    var _url = $scope._token['url']+ $scope.subUrl;
    if($.isEmptyObject($scope._token)) return false;
    window.open(_url+'/files/'+_name+'/'+$scope.dataForm[_name], '_blank'); 
  }

  $scope.confirmDelete = function(_data, _index){
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;
      
      var isConfirmDelete = confirm('Anda yakin mau menghapus data ini?');
      if(isConfirmDelete){
        $http({
          'method'  : 'DELETE',
          'url'     : _url+'/'+_data.no 
        }).success(function(response){
          $scope._data.splice(_index,1);
            new PNotify({
              title : 'Berhasil',
              text  : 'Data Berhasil Dihapus',
              type  : 'success'
          });
        }).error(function(response){
          new PNotify({
              title : 'Gagal',
              text  : 'Data Gagal Dihapus',
              type  : 'error'
          });
        });
      }
    }

  $scope.searchDB = function(){
      if($.isEmptyObject($scope._token)) return false;
        if($scope.searchText.length >= 1){
          // console.log($scope.libraryTemp);
          if($.isEmptyObject($scope.libraryTemp)){
                $scope.libraryTemp = $scope._data;
                $scope.totalItemsTemp = $scope.totalItems;
                $scope._data = {};
          }
          getResultsPage(1);
        }else{
          // console.log('masuk');
            if(!$.isEmptyObject($scope.libraryTemp)){
                $scope._data = $scope.libraryTemp ;
                $scope.totalItems = $scope.totalItemsTemp;
                $scope.libraryTemp = {};
            }
        }
    } 

  $scope.setApv = function(_answer, _index){
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;

      //console.log(_answer+'/'+_index);
      $http({
        'method'  : 'PUT',
        'url'     : _url+'/'+$scope.dataForm['id_spks']+'/apv', 
        'data'    : { 'jawaban' : _answer, 'komentar' : $scope.dataForm['apv'][_index]['komentar'], 'apv_nip' : $scope.dataForm['apv'][_index]['apv_nip'] },
        // 'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
      }).success(function(response){
        $scope.dataForm['apv'][_index]['apv_status']=_answer;
        // // console.log(response);
        // $scope._data     = response.data;
        // $scope.totalItems   = response.total;
        // $scope.table = { TotalItems : response.total, CurrentItems : response.to };
      }).error(function(response){
        //console.log(response);
      });

  }  

  $scope.lovAllPerusahaan = function (_index, _tipe, _value) {
      if($.isEmptyObject($scope.dataForm)){
        $scope.dataForm = {};
      }
    $scope.params = { };//_f_customer : (_customer) ? _customer : $scope.dataForm['f_customer']  };
    var modalInstance = $uibModal.open({
      animation: true,
      templateUrl:  '/assets/ng/views/sdm/lov/lovAllPerusahaan.html', 
      controller:   'lovAllPerusController',
      size: 'lg',
      resolve: {
        parameter : function(){
          return $scope.params;
        }, 
      }
    });
    modalInstance.result.then(function (_element) {
      $scope.dataForm['region_id']        = _element.kode;
      $scope.dataForm['nama_perusahaan']  = _element.nama;
    }, function () {
      $log.info('Modal dismissed at: ' + new Date());
    });
  }

  $scope.cekCoa = function (){
    var _url = $scope._token['url']+ $scope.subUrl;
    if(!$.isEmptyObject($scope.dataForm['parent_id']) && !$.isEmptyObject($scope.dataForm['account_id'])) {
      var parent  = $scope.dataForm['parent_id'];
      var account = $scope.dataForm['account_id'];
      $http.get(_url+"/"+parent+"."+account+"/edit").success(function(response){
        if(!$.isEmptyObject(response)) { 

          new PNotify({
              title : 'Peringatan!',
              text  : 'COA Id '+parent+'.'+account+' sudah ada!',
              type  : 'warning'
          });

          $scope.dataForm['parent_id']  = '';
          $scope.dataForm['account_id'] = '';
        }
      });
    }
  }

  $scope.save = function(modalstate, id){
    var _url = $scope._token['url']+ $scope.subUrl;
    if($.isEmptyObject($scope._token)) return false;

    $scope.dataForm['coa_desc'] = ($scope.dataForm['coa_desc']) ? $scope.dataForm['coa_desc'].toString() : '' ;
    delete $scope.dataForm['nama_perusahaan'];

    $http({
      'method'  : ($scope.dataForm['coa_id']) ? 'PUT' : 'POST',
      'url'     : _url + (($scope.dataForm['coa_id']) ? '/'+$scope.dataForm['coa_id'] : ''),
      'data'    : $.param($scope.dataForm),
      'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
    }).success(function(response){
      if(modalstate === 'edit') {
          new PNotify({
              title : 'Berhasil',
              text  : 'Edit Data Berhasil',
              type  : 'success'
          });
      }
      else {
          new PNotify({
              title : 'Berhasil',
              text  : 'Input Data Berhasil',
              type  : 'success'
          });
      }
      showData(response);
      $scope.modalstate = 'edit'; 
    }).error(function(error){
      console.log(error);
    });
  }

  function getResultsPage(pageNumber) {
      $scope.formTampil = false;      
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;
      
      $scope._pageNumber = pageNumber;
      
      if(! $.isEmptyObject($scope.libraryTemp)){
        $http({
          'method'  : 'GET',
          'url'   : _url+'?search='+$scope.searchText+'&page='+pageNumber 
        }).success(function(response){
          $scope._data     = response.data;
          $scope.totalItems   = response.total;
          $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
          //console.log(response);
        });
      }else{
        $http({
          'method'  : 'GET',
          'url'   : _url+'?page='+pageNumber 
        }).success(function(response){
          //console.log(response);
          $scope._data        = response.data;
          $scope.totalItems   = response.total;
          $scope.table        = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
           //console.log(response);
        });
      }
  }

  function showData(_dataTampil){

    //console.log(_dataTampil);

    $scope.dataForm = {};
    $scope.dataForm = _dataTampil;


    $scope.dataForm['nama_perusahaan']          = _dataTampil.nama;
    $scope.dataForm['coa_level']                = Number(_dataTampil.coa_level);
    $scope.dataForm['coa_sub_acct']             = (_dataTampil.coa_sub_acct == '1') ? true : '';
    $scope.dataForm['coa_revaluation']          = (_dataTampil.coa_revaluation == '1') ? true : '';
    $scope.dataForm['coa_revaluation_current']  = (_dataTampil.coa_revaluation_current == '1') ? true : '';

    //console.log($scope.dataForm['coa_sub_acct']);
    
    delete $scope.dataForm['kode'];
    delete $scope.dataForm['nama'];

    /*delete $scope.dataForm['gl']['acc_cost_center'];
    delete $scope.dataForm['gl']['acc_coas_mst'];*/
  }

});

app.directive('formCoasMst', function (){
    return{
        restirct    : 'A',
        templateUrl : '/assets/ng/views/acc/form/formCoasMst.html',
    };
});

app.directive('lovCustomer', function (){
    return{
        restirct    : 'A',
        templateUrl : '/ext/ng-html/PMS/lov/lovCustomer.html',
    };
});


function apiModifyTable(originalData,id,response){
    angular.forEach(originalData, function (item,key) {
      // console.log(item.id_customer +' \\ '+key+' / '+id);
        if(item.no == id){
            originalData[key] = response;
        }
    });
    return originalData;
}