var app = angular
          .module('appRoot', ['ngMessages', 'ngRoute', 'ui.bootstrap', 'rte-angular'])
          .config(function($interpolateProvider){
              $interpolateProvider.startSymbol('[[');
              $interpolateProvider.endSymbol(']]');
          })
        .directive('loading', ['$http',function($http){
          return {
            restrict: 'A',
            link : function(scope, element, attrs){
              scope.isLoading = function(){
                return $http.pendingRequests.length > 0;
              };

              scope.$watch(scope.isLoading, function(value){
                if(value){
                  element.show(); 
                } else{
                  element.hide();
                }
              })
            }
          }
        }]);


app.controller('dataFormController', function($scope, $http, $uibModal, $log) {
  // $scope.modalstate = {};
  // $scope.parseInt = parseInt;
  // $scope.libraryTemp = {};
  $scope.dataForm = {};
  $scope.subUrl = '/keu/penerimaan';
  // $modalName ='idModalMst';
  $scope._token = {};
  $scope.confirm
  // $scope._pageNumber = 1;

    $http({
      'method'  : 'GET',
      'url'   : '/token' 
    }).success(function(response){
      // console.log(response);
      $scope._token     = response;
      $scope.frmMstPasswd['show'] = true;
  
      //retrieve employees listing from API
      // getResultsPage($scope._pageNumber);

    }).error(function(response){
        console.log(response);
    });


    $scope.setChangePassword = function(){
      console.log($scope.dataForm['passwd']);
      var _url = $scope._token['url']+ '/sites/profile/password';
      if($.isEmptyObject($scope._token)) return false;

      $http({
        'method'  : 'PUT',
        'url'     : _url,
        'data'    : $.param($scope.dataForm['passwd']),
        'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
      }).success(function(response){
        // console.log(response);
        // $scope.toggle('edit',response.id_pnwr);
        //showData(response);
        //$scope.modalstate = 'edit'; 


        new PNotify({
              title: 'Application',
              text: response.message,
              type : response.type
          });

        $scope.dataForm['passwd'] = (response.type =='success' ) ? {} : $scope.dataForm['passwd'];
        $scope.frmMstPasswd['show'] = (response.type =='success' ) ? false : true;

      }).error(function(error){
        new PNotify({
              title: 'Application',
              text: error,
              type : 'error'
          });
      });
    }

    $scope.passwordVerify = function() {
      // console.log($scope.dataForm['passwd']['password'] == $scope.dataForm['passwd']['confirm_password']);
      frmMstPasswd.password_confirmation.$invalid
      return $scope.dataForm['passwd']['password'] == $scope.dataForm['passwd']['confirm_password'];
        // return {
        //   restrict: 'A', // only activate on element attribute
        //   require: '?ngModel', // get a hold of NgModelController
        //   link: function(scope, elem, attrs, ngModel) {
        //     if (!ngModel) return; // do nothing if no ng-model

        //     // watch own value and re-validate on change
        //     scope.$watch(attrs.ngModel, function() {
        //       validate();
        //     });

        //     // observe the other value and re-validate on change
        //     attrs.$observe('passwordVerify', function(val) {
        //       validate();
        //     });

        //     var validate = function() {
        //       // values
        //       var val1 = ngModel.$viewValue;
        //       var val2 = attrs.passwordVerify;

        //       // set validity
        //       ngModel.$setValidity('passwordVerify', val1 === val2);
        //     };
        //   }
        // }
      }
    //show modal form
// app.directive('formPenerimaan', function (){
//     return{
//         restirct    : 'A',
//         templateUrl : '/assets/ng/views/keu/form/formPenerimaan.html',
//     };
// });
/*
    $scope.toggle = function(modalstate, id){
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;

      $scope.modalstate = modalstate; 

      switch(modalstate){
        case 'add' :
          $scope.form_title = 'Tambah Data';
          $scope.dataForm = {};
          $scope.dataForm['det'] = [1];
          $scope.dataForm['jurnal_det'] = [];
          // $scope.dataForm['ar_det'] = [1];
          // $scope.dataForm['ap_det'] = [1];
          $scope.formTampil = true;
        break;
        case 'edit' :
          $scope.form_title = 'Edit Data';
          $scope.idState = id;
          // $http.get(API_URL + $scope.subUrl+"/" + id)
          $http.get(_url+"/" +id+'/edit')
            .success(function(response){
              showData(response);
            });
          $scope.formTampil = true;
          console.log($scope.modalstate);      
        break;
        case 'cancel':
          getResultsPage($scope._pageNumber);
        break; 
        default:
        break;
      }
      // $('#'+$modalName).modal('show');
    }

    $scope.save = function(modalstate, id){
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;

      // var _method = ($scope.dataForm['no_bukti']) ? 'PUT' : 'POST';
      console.log($scope.dataForm['tgl_terima']);
      $scope.dataForm['keterangan'] = $scope.dataForm['keterangan'].toString();
      // $scope.dataForm['tgl_terima'] = [[ $scope.dataForm['tgl_terima']  | date:'MM/dd/yyyy @ h:mma' ]];
      // console.log('tanggal : ' + $scope.dataForm['tgl_terima']);
      $http({
        'method'  : ($scope.dataForm['no_bukti']) ? 'PUT' : 'POST',
        'url'     : _url + (($scope.dataForm['no_bukti']) ? '/'+$scope.dataForm['no_bukti'] : ''),
        'data'    : $.param($scope.dataForm),
        'headers' : {'Content-Type': 'application/x-www-form-urlencoded'}
      }).success(function(response){
        console.log(response);
        // $scope.toggle('edit',response.id_pnwr);
        showData(response);
        $scope.modalstate = 'edit'; 

        $.gritter.add({
              title: 'Application',
              text: 'Data Berhasil Disimpan',
              fade_out_speed: 5000
          });
      }).error(function(error){
        console.log(error);
      });
    }

    $scope.confirmDelete = function(_data, _index){
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;
      
      var isConfirmDelete = confirm('Anda yakin mau menghapus data ini?');
      if(isConfirmDelete){
        $http({
          'method'  : 'DELETE',
          'url'     : _url+'/'+_data.id_spks 
        }).success(function(response){
          $scope._data.splice(_index,1);
          $.gritter.add({
                title: 'Application',
                text: 'Data Berhasil Dihapus',
                fade_out_speed: 5000
            });
        }).error(function(response){
          console.log(response);
          $.gritter.add({
                title: 'Application',
                text: 'Data Gagal Dihapus',
                fade_out_speed: 5000
            });
        });
      }
    }
  
*/


  /*
  * kawasan LOV script
  *
  *
  */
/*
  $scope.lovBank = function (_index, _tipe, _value) {
      if($.isEmptyObject($scope.dataForm)){
        $scope.dataForm = {};
      }

    $scope.params = { };//_f_customer : (_customer) ? _customer : $scope.dataForm['f_customer']  };
    var modalInstance = $uibModal.open({
      animation: true,
      templateUrl:  '/assets/ng/views/keu/lov/lovBank.html', 
      controller: 'lovBankController',
      size: 'lg',
      resolve: {
        parameter : function(){
          return $scope.params;
        }, 
      }
    });
    modalInstance.result.then(function (_element) {
      // dataForm.det[$index].no_bank
      if($.isEmptyObject($scope.dataForm)){
        $scope.dataForm = {};
      }
      if(_tipe === 'tambah'){// && $scope.dataForm['det'][0]['no'] !== ''){
        var _data       = new Object();
        _data.no_bank        = _element.no;
        _data.nama_bank = _element.nama_bank;
        $scope.dataForm['det'].push(_data);
      } else if(_index || _index === 0){
        // console.log(_element.no+'/'+_index);
        
        $scope.dataForm['det'][_index]= {} ;
        $scope.dataForm['det'][_index]['no_bank']   = _element.no;
        $scope.dataForm['det'][_index]['nama_bank'] = _element.nama_bank;
      } 
      // else {
      //   $scope.dataForm['det']['no'] = _element.no;
      //   $scope.dataForm['det']['nama_bank'] = _element.nama_bank;
      // } 
    }, function () {
      $log.info('Modal dismissed at: ' + new Date());
    });
  }

  $scope.rmLovBank = function (_data, _bukti, _index) {
      var _url = $scope._token['url'];
      if($.isEmptyObject($scope._token)) return false;

      var isConfirmDelete = confirm('Anda yakin mau menghapus data ini?');
      if(isConfirmDelete){
        if(_bukti){        
          $http({
            'method'  : 'DELETE',
            'url'     : _url+'/keu/penerimaan/det/bukti',
            'params'  : { 'no_bukti' : _bukti, 'data' : _data } 
          }).success(function(response){
            // $scope.dataForm['fp_det'].splice(_index,1);          
            // $scope.save('edit',$scope.dataForm['id_fp']);

          }).error(function(response){
            console.log(response);
            $.gritter.add({
                  title: 'Application',
                  text: 'Data Gagal Dihapus',
                  fade_out_speed: 5000
              });
          });
        }
        
        $scope.dataForm['det'].splice(_index,1);          
      }
  }
*/
  /*
  * batas kawasan lov script
  *
  *
  */


/*
  function getResultsPage(pageNumber) {
      $scope.formTampil = false;      
      var _url = $scope._token['url']+ $scope.subUrl;
      if($.isEmptyObject($scope._token)) return false;
      
      $scope._pageNumber = pageNumber;
      
      if(! $.isEmptyObject($scope.libraryTemp)){
        $http({
          'method'  : 'GET',
          'url'   : _url+'?search='+$scope.searchText+'&page='+pageNumber 
        }).success(function(response){
          // console.log(response);
          $scope._data     = response.data;
          $scope.totalItems   = response.total;
          $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
            console.log(response);
        });
      }else{
        $http({
          'method'  : 'GET',
          // 'method'  : 'JSONP',
          'url'   : _url+'?page='+pageNumber 
        }).success(function(response){
          // console.log(response);
          $scope._data     = response.data;
          $scope.totalItems   = response.total;
          $scope.table = { TotalItems : response.total, CurrentItems : response.to };
        }).error(function(response){
          console.log(response);
        });
      }
  }

  function showData(_dataTampil){
    $scope.dataForm               = [];
    $scope.dataForm               = _dataTampil;
    $scope.dataForm['tgl_terima'] = new Date(_dataTampil['tgl_terima']);
    $scope.dataForm['keterangan'] = $sce.trustAsHtml(_dataTampil['keterangan']);
    
    for(det in _dataTampil.fa_penerimaan_det){
      _dataTampil.fa_penerimaan_det[det]['nama_bank']       =  _dataTampil.fa_penerimaan_det[det]['fa_bank_mst']['nama_bank'];
      _dataTampil.fa_penerimaan_det[det]['jatuh_tempo']     =  new Date(_dataTampil.fa_penerimaan_det[det]['jatuh_tempo']);
    }

    for(det in _dataTampil.fa_penerimaan_jurnal_det){
      _dataTampil.fa_penerimaan_jurnal_det[det]['nama_coa'] =  (_dataTampil.fa_penerimaan_jurnal_det[det]['coa']) ? _dataTampil.fa_penerimaan_jurnal_det[det]['coa']['coa_name'] : null;
    }

    $scope.dataForm['det']        = _dataTampil.fa_penerimaan_det;
    $scope.dataForm['jurnal_det'] = _dataTampil.fa_penerimaan_jurnal_det;
    $scope.dataForm['ar_det']     = _dataTampil.fa_penerimaan_ar_det;
    $scope.dataForm['ap_det']     = _dataTampil.fa_penerimaan_ap_det;
    delete $scope.dataForm['fa_penerimaan_det'];
    delete $scope.dataForm['fa_penerimaan_jurnal_det'];
    delete $scope.dataForm['fa_penerimaan_ar_det'];
    delete $scope.dataForm['fa_penerimaan_ap_det'];
  }
*/
});
/*
app.directive('formPenerimaan', function (){
    return{
        restirct    : 'A',
        templateUrl : '/assets/ng/views/keu/form/formPenerimaan.html',
    };
});
*/
